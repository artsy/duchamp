name: Claude AI PR Review

on:
  workflow_call:
    secrets:
      anthropic-api-key:
        required: true
    inputs:
      model:
        description: "Claude model to use for the review"
        default: "claude-opus-4-20250514"
        required: false
        type: string
      timeout-minutes:
        description: "Maximum time for the review job"
        default: 30
        required: false
        type: number

jobs:
  check:
    runs-on: ubuntu-latest
    # Fast-path exclusions: drafts, bots, dependabot, renovate (zero overhead)
    if: |
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.user.login, '[bot]') &&
      github.event.pull_request.user.login != 'dependabot' &&
      github.event.pull_request.user.login != 'renovate'
    permissions:
      contents: read
      pull-requests: write
    outputs:
      should-review: ${{ steps.org-check.outputs.should-review }}
    steps:
      - name: Checkout PR repo (sparse - config only)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          sparse-checkout: .claude-review.yml
          sparse-checkout-cone-mode: false

      - name: Checkout tooling repo
        uses: actions/checkout@v4
        with:
          repository: artsy/duchamp
          ref: main
          path: .tooling

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Enable Corepack
        run: corepack enable

      - name: Install tooling dependencies
        run: yarn install --frozen-lockfile
        working-directory: .tooling
        env:
          YARN_IGNORE_PATH: 1

      - name: Check title exclusions
        id: title-check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { checkTitleExclusion } = require('./.tooling/scripts/check-pr-exclusions.js');

            const title = context.payload.pull_request.title;

            // Read config from checked-out file
            let configContent = null;
            try {
              configContent = fs.readFileSync('.claude-review.yml', 'utf8');
            } catch {
              // No config file, use defaults only
            }

            const result = checkTitleExclusion(title, configContent);

            console.log(`Title: "${title}"`);
            console.log(`Config found: ${configContent !== null}`);
            console.log(`Excluded: ${result.excluded}`);
            if (result.reason) console.log(`Reason: ${result.reason}`);

            core.setOutput('excluded', result.excluded.toString());
            core.setOutput('reason', result.reason || '');

      - name: Check if author can write to repo
        id: org-check
        if: steps.title-check.outputs.excluded != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const username = context.payload.pull_request.user.login;
            const prNumber = context.payload.pull_request.number;

            // Check if user has write permission to the repo (members/collaborators do)
            try {
              const { data: permissionLevel } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: username
              });

              const permission = permissionLevel.permission;
              console.log(`Author: ${username}, Permission: ${permission}`);

              // admin, write, maintain = trusted; read, none = not trusted
              const trustedPermissions = ['admin', 'write', 'maintain'];

              if (trustedPermissions.includes(permission)) {
                console.log(`âœ“ ${username} has trusted permission: ${permission}`);
                core.setOutput('should-review', 'true');
              } else {
                console.log(`âœ— ${username} has permission: ${permission}. Skipping AI review.`);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `ðŸ¤– **AI Review skipped** - PR author does not have write access to this repository.`
                });
                core.setOutput('should-review', 'false');
              }
            } catch (error) {
              // If we can't check permissions, user is likely not a collaborator
              console.log(`âœ— Could not verify permissions for ${username}: ${error.message}`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ðŸ¤– **AI Review skipped** - Could not verify PR author has access to this repository.`
              });
              core.setOutput('should-review', 'false');
            }

  review:
    needs: check
    if: needs.check.outputs.should-review == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    concurrency:
      group: claude-review-${{ github.repository }}-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: write  # Required for resolveReviewThread GraphQL mutation
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Checkout tooling repo
        uses: actions/checkout@v4
        with:
          repository: artsy/duchamp
          ref: main
          path: .tooling

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Enable Corepack
        run: corepack enable

      - name: Install tooling dependencies
        run: yarn install --frozen-lockfile
        working-directory: .tooling
        env:
          YARN_IGNORE_PATH: 1

      - name: Build review prompt
        id: prompt
        run: npx ts-node .tooling/scripts/build-review-prompt.ts

      - name: Cleanup previous AI review comments
        uses: actions/github-script@v7
        with:
          script: |
            const { cleanupPreviousAIReviews } = require('./.tooling/scripts/cleanup-ai-reviews.js');
            await cleanupPreviousAIReviews({ github, context, core });

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.anthropic-api-key }}
          claude_args: '--model ${{ inputs.model }} --allowedTools "Read,Glob,Grep,Bash(git diff:*),Bash(git log:*),Bash(git show:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),mcp__github_inline_comment__create_inline_comment"'
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            BASE BRANCH: ${{ github.event.pull_request.base.ref }}

            The PR branch has been checked out. You have full access to the codebase.
            Use Read, Glob, and Grep to explore files. Use `git diff origin/${{ github.event.pull_request.base.ref }}...HEAD` to see changes.

            If a CLAUDE.md file exists in the repo root, read it first for project-specific guidelines.

            ${{ steps.prompt.outputs.review_prompt }}

            ## How to Post Your Review
            Use `gh pr comment ${{ github.event.pull_request.number }}` for your main review.
            Use `mcp__github_inline_comment__create_inline_comment` for inline code comments.
            Only post GitHub comments - do not submit review text as messages.
